/**
 * Nico Pr â€” https://nicopr.fr
 * JSPEK PACKAGE RELEASE v0.0.4
 * 13/12/2025 00:14:49
 */
(function(){const C={};function D(a){if(C[a])return C[a];const b=new Uint32Array(a),c=new Float32Array(a/2),d=new Float32Array(a/2);for(let e=1,f=a>>1;e<a;e<<=1,f>>=1)for(var g=0;g<e;g++)b[g+e]=b[g]+f;g=-2*Math.PI/a;for(let e=0;e<a/2;e++)c[e]=Math.cos(g*e),d[e]=Math.sin(g*e);return C[a]={n:a,G:b,cos:c,sin:d}}
function E({n:a,G:b,cos:c,sin:d},g,e){for(var f=0;f<a;f++){var l=b[f];if(l>f){var m=g[f];g[f]=g[l];g[l]=m;m=e[f];e[f]=e[l];e[l]=m}}for(b=2;b<=a;b*=2)for(f=b/2,l=a/b,m=0;m<a;m+=b)for(let t=0;t<f;t++){const u=m+t,n=u+f;var k=t*l,h=c[k];const w=d[k];k=g[n]*h-e[n]*w;h=g[n]*w+e[n]*h;g[n]=g[u]-k;e[n]=e[u]-h;g[u]+=k;e[u]+=h}}const F=new Uint32Array(256);
for(let a=0;a<256;a++){const b=a/255;F[a]=4278190080|(b<.6?.5*Math.sin(b/.6*Math.PI):b<.78?0:(b-.78)/.22)*255<<16|(b<.6?0:b<.91?Math.sin((b-.6)/.31*Math.PI/2):1)*255<<8|(b<.13?0:b<.73?Math.sin((b-.13)/.6*Math.PI/2):1)*255}function G(a){a.i&&(cancelAnimationFrame(a.i),a.i=null)}
function H(a){G(a);const b=a.h;var c=a.D;const d=c.x,g=c.y,e=c.w,f=c.F,l=a.j,m=a.A,k=a.min;c=a.max;const h=a.l.getChannelData(0),t=h.length,u=D(l),n=l>>1,w=t/e|0,A=20*Math.log10(1/l),q=new Float32Array(l),y=new Float32Array(l),z=b.createImageData(e,f),Q=new Uint32Array(z.data.buffer),R=c-k;I(a);let x=0;const L=()=>{const J=x;for(let S=Math.min(x+50,e);x<S;x++){var v=x*w-n,B=0,p=0;for(var r=0;r<l;r++)v+r>=0&&v+r<t&&(B+=h[v+r],p++);p>0&&(B/=p);for(p=0;p<l;p++)q[p]=(v+p>=0&&v+p<t?h[v+p]-B:0)*m[p],y[p]=
0;E(u,q,y);for(v=0;v<f;v++){r=(f-v-1)/f*n|0;B=(f-v)/f*n|0;for(p=0;r<=B&&r<n;r++){const K=q[r]*q[r]+y[r]*y[r];K>p&&(p=K)}Q[v*e+x]=F[Math.max(0,Math.min(255,(10*Math.log10(p+1E-20)+A-k)/R*255|0))]}}b.putImageData(z,d,g,J,0,x-J,f);x<e&&(a.i=requestAnimationFrame(L))};a.i=requestAnimationFrame(L)}
function I(a){const b=a.h;var c=a.D,d=c.I,g=c.H;const e=c.x,f=c.y,l=c.w;c=c.F;var m=a.C,k=a.l,h=a.v;const t=a.min,u=a.max;if(d&&(b.fillStyle="#000",b.fillRect(0,0,d,g),b.fillStyle="#757575",b.font=`${13*m}px ${"system-ui"}`,b.textAlign="left",b.textBaseline="middle",b.fillText(h.B,e,f/2),d=e+b.measureText(h.B).width+10*m,b.font=`${11*m}px ${"system-ui"}`,b.fillText(h.u,d,f/2),k)){d=10*m;b.font=`${d}px ${"system-ui"}`;b.textAlign="right";var n=k.sampleRate/2;g=[1E3,2E3,5E3,1E4,2E4].find(q=>n/q<=20)||
2E4;for(h=0;h<=n;h+=g){var w=f+c-h/n*c;w>f+d&&w<f+c-d&&M(a,e,w,h)}M(a,e,f-1,n);M(a,e,f+c,0);b.textAlign="center";b.textBaseline="top";var A=k.duration;k=[1,2,5,10,30,60,120,300,600].find(q=>A/q<=20)||600;for(d=0;d<=A;d+=k)a.time(e+d/A*l,f+c,d);a=3*m;k=e+l+a;g=f-1;m*=12;d=c+1;b.textAlign="left";b.textBaseline="middle";h=b.createImageData(m,d);w=new Uint32Array(h.data.buffer);for(let q=0;q<d;q++){const y=F[(1-q/c)*255|0];for(let z=0;z<m;z++)w[q*m+z]=y}b.putImageData(h,k,g);for(g=t;g<=u;g+=10)h=f+c-
(g-t)/(u-t)*d,b.fillText(g+"dB",k+m+6,h),b.fillRect(k-a,h,6,1);b.strokeStyle="#757575";b.lineWidth=1;b.strokeRect(e,f,l,c)}}function N(a){const b=a.C,c=Math.floor(a.g.clientWidth*b),d=Math.floor(a.g.clientHeight*b);a.m.width=c;a.m.height=d;a.D={x:Math.floor(40*b),y:Math.floor(30*b),w:Math.floor(c-96*b),F:Math.floor(d-50*b),I:c,H:d};a.l?H(a):I(a)}function M(a,b,c,d){a.h.fillText(Math.round(d/1E3)+"kHz",b-a.o-4,c);a.h.fillRect(b-a.o,c,a.o,1)}
class O{constructor(a,b){this.C=window.devicePixelRatio||1;this.j=2048;this.min=-120;this.max=0;this.o=4*this.C;this.i=this.l=null;this.v={B:"",u:""};this.D={};this.A=null;this.g=document.createElement("div");this.g.classList.add("spek");this.m=document.createElement("canvas");this.g.append(this.m);this.h=this.m.getContext("2d",{alpha:!1});b.append(this.g);this.load(a)}async load(a){this.v={B:a.name,u:"Loading..."};I(this);try{var b=await a.arrayBuffer();const c=new DataView(b);let d=44100,g=null,
e=12;if(c.getUint32(0)===1380533830)for(;e<c.byteLength;){if(c.getUint32(e)===1718449184){d=c.getUint32(e+12,!0);g=c.getUint16(e+22,!0);break}e+=8+c.getUint32(e+4,!0)}else c.getUint32(0)===1716281667&&(d=c.getUint8(18)<<12|c.getUint8(19)<<4|c.getUint8(20)>>4,g=((c.getUint8(20)&1)<<4|c.getUint8(21)>>4)+1);const f=await (new OfflineAudioContext(1,1,d)).decodeAudioData(b);this.j=f.sampleRate>88200?8192:f.sampleRate>44100?4096:2048;this.A=new Float32Array(this.j);for(b=0;b<this.j;b++)this.A[b]=.5*(1-
Math.cos(2*Math.PI*b/this.j));const l=f.duration,m=a.size;a=m/1048576;this.v.u=`${Math.round(f.sampleRate/1E3)}kHz${g?`  ${g}bit`:""}  ${f.numberOfChannels}ch  ${`${l/60|0}:${(l%60|0).toString().padStart(2,"0")}`}  ${m*8/l/1E3|0}kbps  ${a>=1?a.toFixed(2)+"MB":(m/1024).toFixed(1)+"KB"}`;this.l=f;H(this)}catch(c){this.v.u="Error : "+c.message,I(this)}}time(a,b,c){this.h.fillText(`${c/60|0}:${(c%60|0).toString().padStart(2,"0")}`,a,b+this.o+4);this.h.fillRect(a-1,b,1,this.o)}}
function P(a){a=a.g.filter(k=>!!k.l).map(k=>k.m);if(a.length){var {width:b,height:c}=a[0],d=Math.ceil(Math.sqrt(a.length)),g=Math.ceil(a.length/d),e=Math.min(1,4096/(d*b),4096/(g*c)),f=b*e,l=c*e;g=new OffscreenCanvas(d*f,g*l);var m=g.getContext("2d",{alpha:!1});a.forEach((k,h)=>m.drawImage(k,h%d*f,Math.floor(h/d)*l,f,l));g.convertToBlob().then(k=>{k=URL.createObjectURL(k);const h=document.createElement("a");h.download=`jspek_${Date.now()}.png`;h.href=k;h.click();URL.revokeObjectURL(k)})}}
function T(a,b=!1){var c=a.g.length;if(c){var d=Math.ceil(Math.sqrt(c));c=Math.ceil(c/d);a.app.style.gridTemplateColumns=`repeat(${d}, 1fr)`;a.app.style.gridTemplateRows=`repeat(${c}, 1fr)`;var g=d!==a.h||c!==a.i;a.h=d;a.i=c;if(g||b===!0)for(const e of a.g)N(e);else b instanceof O&&N(b)}}
class U{constructor(){this.g=[];this.app=document.getElementById("app");this.j=null;this.i=this.h=0;const a=document.getElementById("f"),b=c=>[...c].forEach(d=>this.add(d));a.onchange=()=>{b(a.files);a.value=""};document.body.ondragover=c=>c.preventDefault();document.body.ondrop=c=>{c.preventDefault();b(c.dataTransfer.files)};document.getElementById("browse").onclick=()=>a.click();document.getElementById("save").onclick=()=>P(this);window.onresize=()=>{clearTimeout(this.j);this.j=setTimeout(()=>T(this,
!0),123)}}add(a){const b=new O(a,this.app);this.g.push(b);T(this,b);b.g.addEventListener("dblclick",()=>{const c=this.g.indexOf(b);if(c>-1){var d=this.g[c];G(d);d.g.remove();this.g.splice(c,1);T(this)}},{once:!0})}}window.addEventListener("load",()=>new U);}).call(this);
